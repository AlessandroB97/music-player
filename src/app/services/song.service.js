"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var song_1 = require("../models/song");
var Sqlite = require("nativescript-sqlite");
var fileSystemModule = require("tns-core-modules/file-system");
var file_system_1 = require("tns-core-modules/file-system");
var music_metadata_1 = require("music-metadata");
var platform_1 = require("tns-core-modules/platform");
var buffer_1 = require("buffer");
var imageSource = require("tns-core-modules/image-source");
var SongService = /** @class */ (function () {
    function SongService() {
        this.songs = [];
        // mmr: MediaMetadataRetriever;
        this.img = new imageSource.ImageSource();
        // getMetadata(entity :fileSystemModule.FileSystemEntity) {
        //     //Set the data source for the media file
        //     console.log(entity.path);
        //     this.mmr.setDataSource(entity.path);
        //     //Get the Embedded Picture(Bitmap)
        //     // this.mmr.getEmbeddedPicture()
        //     // .then((args) => {
        //     //     if(args) {
        //     //         this.img.setNativeSource(args);
        //     //     console.log("IMMAGINE: "+ this.img.toBase64String("jpg"));
        //     //     }
        //     // })
        //     // .catch((ex) => {
        //     //     //Do something else
        //     //     console.log("Failed to set ImageSource..." + ex);
        //     // });
        //     //Get all the metadata
        //     this.mmr.extractAllMetadata()
        //     .then((args) => {
        //         // if(args._mediaMetadataRetriever.getEmbeddedPicture()){
        //         //     this.img.setNativeSource(args.image);
        //         // }
        //         this.img.setNativeSource(args.image);
        //         this.insertDB( 
        //         args.title? args.title : "",
        //         args.artist? args.artist : "",
        //         this.img? "data:image/jpg;base64," +this.img.toBase64String("png") : "",//"data:image/jpeg;base64," + args.picture[0].data.toString('base64') : "",
        //         args.album? args.album : "",
        //         args.genre? args.genre : "",
        //         args.cdtracknumber? args.cdtracknumber : "",
        //         args.year? args.year.toString() : "",
        //         entity.path
        //         );
        //     });
        // }
    }
    SongService.prototype.initDb = function () {
        var songFolder;
        if (platform_1.isAndroid) {
            var androidPath = android.os.Environment.getExternalStorageDirectory().getAbsolutePath();
            songFolder = file_system_1.Folder.fromPath(fileSystemModule.path.join(androidPath, "Music/Prova")); //Folder.fromPath("sdcard/Music/Jesto/Justin/");
        }
        if (platform_1.isIOS) {
            songFolder = file_system_1.knownFolders.ios.music();
        }
        (new Sqlite("songs.db")).then(function (db) {
            db.execSQL("DROP TABLE IF EXISTS songs");
            db.execSQL("CREATE TABLE IF NOT EXISTS songs (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, artist TEXT, image TEXT, album TEXT, genre TEXT, track TEXT, year TEXT, path TEXT)").then(function (id) {
            }, function (error) {
                console.log("CREATE TABLE ERROR", error);
            });
        }, function (error) {
            console.log("OPEN DB ERROR", error);
        });
        this.checkSongs(songFolder);
    };
    SongService.prototype.checkSongs = function (songFolder) {
        var _this = this;
        var array = [];
        songFolder.getEntities()
            .then(function (entities) {
            // entities is array with the document's files and folders.
            entities.forEach(function (entity) {
                if (fileSystemModule.Folder.exists(entity.path)) {
                    array = array.concat(_this.checkSongs(fileSystemModule.Folder.fromPath(entity.path)));
                }
                else if (!entity.path.endsWith("db")) {
                    var tags;
                    var extension = entity.path.slice((entity.path.lastIndexOf(".") - 1 >>> 0) + 2);
                    console.log("-----------------");
                    console.log("path: " + entity.path);
                    console.log("ESTENSIONE: " + extension);
                    switch (extension) {
                        case "mp2":
                        case "mp3":
                        case "m2a":
                            console.log("AGGIUNGO COME mpeg");
                            _this.insertSong(entity, "mpeg");
                            break;
                        case "ape":
                            console.log("AGGIUNGO COME ape");
                            _this.insertSong(entity, "apev2");
                            break;
                        case "aac":
                        case "mp4":
                        case "m4a":
                        case "m4b":
                        case "m4pa":
                        case "m4v":
                        case "m4r":
                        case "3gp":
                            console.log("AGGIUNGO COME mp4");
                            _this.insertSong(entity, "mp4");
                            break;
                        case "wma":
                        case "wmv":
                        case "asf":
                            console.log("AGGIUNGO COME asf");
                            _this.insertSong(entity, "asf");
                            break;
                        case "flac":
                            console.log("AGGIUNGO COME flac");
                            _this.insertSong(entity, "flac");
                            break;
                        case "ogg":
                        case "ogv":
                        case "oga":
                        case "ogm":
                        case "ogx":
                        case "opus": // recommended filename extension for Ogg Opus
                        case "spx": // recommended filename extension for Ogg Speex
                            console.log("AGGIUNGO COME ogg");
                            _this.insertSong(entity, "ogg");
                            break;
                        case "aif":
                        case "aiff":
                        case "aifc":
                            console.log("AGGIUNGO COME aiff");
                            _this.insertSong(entity, "aiff");
                            break;
                        case "wav":
                            console.log("AGGIUNGO COME riff");
                            _this.insertSong(entity, "riff");
                            break;
                        case "wv":
                        case "wvp":
                            console.log("AGGIUNGO COME wavpack");
                            _this.insertSong(entity, "wavpack");
                            break;
                        case "mpc":
                            console.log("AGGIUNGO COME musepack");
                            _this.insertSong(entity, "musepack");
                            break;
                    }
                }
            });
            _this.fetch();
        }).catch(function (err) {
            console.log("ERRORE: " + err.stack);
        });
    };
    SongService.prototype.insertSong = function (entity, format) {
        var _this = this;
        var file = fileSystemModule.File.fromPath(entity.path);
        console.log("INIZIO BUff");
        var buff = buffer_1.Buffer.from(file.readSync());
        console.log(buff);
        // readFile(file.path, "utf8", function(err, data) {  
        //     if (err) throw err;
        //     buff =data;
        // });
        // this.mmr = new MediaMetadataRetriever()
        // this.getMetadata(entity);
        music_metadata_1.parseBuffer(buff, "audio/" + format, { duration: true, fileSize: file.size }).then(function (metadata) {
            // console.log(metadata.common.title);
            _this.insertDB(metadata.common.title ? metadata.common.title : "", metadata.common.artist ? metadata.common.artist : "", metadata.common.picture ? "data:image/jpeg;base64," + metadata.common.picture[0].data.toString('base64') : "", metadata.common.album ? metadata.common.album : "", metadata.common.genre ? metadata.common.genre[0] : "", metadata.common.track.no ? metadata.common.track.no.toString() : "", metadata.common.year ? metadata.common.year.toString() : "", entity.path);
        });
        console.log("INSERIMENTO COMPLETATO!");
    };
    SongService.prototype.insertDB = function (title, artist, image, album, genre, track, year, path) {
        (new Sqlite("songs.db")).then(function (db) {
            db.execSQL("INSERT INTO songs (title, artist, image, album, genre, track, year, path) VALUES (?, ?, ?, ?, ?, ?, ?, ?)", [title, artist, image, album, genre, track, year, path]).then(function (id) {
            }, function (error) {
                console.log("INSERT ERROR", error);
            });
        }, function (error) {
            console.log("OPEN DB ERROR", error);
        });
    };
    SongService.prototype.fetch = function () {
        var _this = this;
        (new Sqlite("songs.db")).then(function (db) {
            db.all("SELECT * FROM songs").then(function (rows) {
                _this.songs = [];
                for (var row in rows) {
                    var song = new song_1.Song;
                    song.Title = rows[row][1];
                    song.Artist = rows[row][2];
                    song.Image = rows[row][3];
                    song.Album = rows[row][4];
                    song.Genre = rows[row][5];
                    song.Track = rows[row][6];
                    song.Year = rows[row][7];
                    song.Path = rows[row][8];
                    _this.songs.push(song);
                }
            }, function (error) {
                console.log("SELECT ERROR", error);
            });
        }, function (error) {
            console.log("OPEN DB ERROR", error);
        });
    };
    SongService = __decorate([
        core_1.Injectable()
    ], SongService);
    return SongService;
}());
exports.SongService = SongService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29uZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic29uZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQW1EO0FBQ25ELHVDQUFzQztBQUN0QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUU1QywrREFBaUU7QUFDakUsNERBQWdGO0FBQ2hGLGlEQUFzRDtBQUN0RCxzREFBNkQ7QUFDN0QsaUNBQThCO0FBQzlCLDJEQUE2RDtBQVE3RDtJQURBO1FBR0ksVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUNuQiwrQkFBK0I7UUFDL0IsUUFBRyxHQUFHLElBQUksV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBK0xwQywyREFBMkQ7UUFDM0QsK0NBQStDO1FBQy9DLGdDQUFnQztRQUNoQywyQ0FBMkM7UUFFM0MseUNBQXlDO1FBQ3pDLHVDQUF1QztRQUN2QywyQkFBMkI7UUFDM0Isd0JBQXdCO1FBQ3hCLGlEQUFpRDtRQUNqRCx3RUFBd0U7UUFDeEUsZUFBZTtRQUNmLFlBQVk7UUFDWiwwQkFBMEI7UUFDMUIsaUNBQWlDO1FBQ2pDLCtEQUErRDtRQUMvRCxhQUFhO1FBRWIsNkJBQTZCO1FBQzdCLG9DQUFvQztRQUNwQyx3QkFBd0I7UUFDeEIsb0VBQW9FO1FBQ3BFLHVEQUF1RDtRQUN2RCxlQUFlO1FBQ2YsZ0RBQWdEO1FBQ2hELDBCQUEwQjtRQUMxQix1Q0FBdUM7UUFDdkMseUNBQXlDO1FBQ3pDLDhKQUE4SjtRQUM5Six1Q0FBdUM7UUFDdkMsdUNBQXVDO1FBQ3ZDLHVEQUF1RDtRQUN2RCxnREFBZ0Q7UUFDaEQsc0JBQXNCO1FBQ3RCLGFBQWE7UUFDYixVQUFVO1FBR1YsSUFBSTtJQUNSLENBQUM7SUFqT1UsNEJBQU0sR0FBYjtRQUNJLElBQUksVUFBa0IsQ0FBQztRQUN2QixJQUFHLG9CQUFTLEVBQUM7WUFDVCxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFD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QUFVLEVBQUU7T0FDQSxXQUFXLENBME92QjtJQUFELGtCQUFDO0NBQUEsQUExT0QsSUEwT0M7QUExT1ksa0NBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkluaXQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgU29uZyB9IGZyb20gXCIuLi9tb2RlbHMvc29uZ1wiO1xudmFyIFNxbGl0ZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xuaW1wb3J0IHsgRGF0YUZvcm1TdHlsZUJhc2UgfSBmcm9tIFwibmF0aXZlc2NyaXB0LXVpLWRhdGFmb3JtXCI7XG5pbXBvcnQgKiBhcyBmaWxlU3lzdGVtTW9kdWxlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ZpbGUtc3lzdGVtXCI7XG5pbXBvcnQgeyBrbm93bkZvbGRlcnMsIEZvbGRlciwgRmlsZSwgcGF0aCB9IGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ZpbGUtc3lzdGVtXCI7XG5pbXBvcnQge3BhcnNlQnVmZmVyLCBwYXJzZUZpbGV9IGZyb20gJ211c2ljLW1ldGFkYXRhJztcbmltcG9ydCB7IGlzSU9TLCBpc0FuZHJvaWQgfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9wbGF0Zm9ybVwiO1xuaW1wb3J0IHtCdWZmZXJ9IGZyb20gXCJidWZmZXJcIjtcbmltcG9ydCAqIGFzIGltYWdlU291cmNlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2ltYWdlLXNvdXJjZVwiO1xuXG5cblxuZGVjbGFyZSB2YXIgYW5kcm9pZDogYW55O1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTb25nU2VydmljZXtcbiAgICBjdXJyZW50U29uZzogU29uZztcbiAgICBzb25nczogU29uZ1tdID0gW107XG4gICAgLy8gbW1yOiBNZWRpYU1ldGFkYXRhUmV0cmlldmVyO1xuICAgIGltZyA9IG5ldyBpbWFnZVNvdXJjZS5JbWFnZVNvdXJjZSgpO1xuICAgIFxuXG5cblxuICAgIHB1YmxpYyBpbml0RGIoKXtcbiAgICAgICAgbGV0IHNvbmdGb2xkZXI6IEZvbGRlcjtcbiAgICAgICAgaWYoaXNBbmRyb2lkKXtcbiAgICAgICAgICAgIHZhciBhbmRyb2lkUGF0aCA9IGFuZHJvaWQub3MuRW52aXJvbm1lbnQuZ2V0RXh0ZXJuYWxTdG9yYWdlRGlyZWN0b3J5KCkuZ2V0QWJzb2x1dGVQYXRoKCk7XG4gICAgICAgICAgICBzb25nRm9sZGVyID0gRm9sZGVyLmZyb21QYXRoKGZpbGVTeXN0ZW1Nb2R1bGUucGF0aC5qb2luKGFuZHJvaWRQYXRoLCBcIk11c2ljL1Byb3ZhXCIpKTsvL0ZvbGRlci5mcm9tUGF0aChcInNkY2FyZC9NdXNpYy9KZXN0by9KdXN0aW4vXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmKGlzSU9TKXtcbiAgICAgICAgICAgIHNvbmdGb2xkZXIgPSBrbm93bkZvbGRlcnMuaW9zLm11c2ljKCk7XG4gICAgICAgIH1cbiAgICAgICAgKG5ldyBTcWxpdGUoXCJzb25ncy5kYlwiKSkudGhlbihkYiA9PiB7XG4gICAgICAgICAgICBkYi5leGVjU1FMKFwiRFJPUCBUQUJMRSBJRiBFWElTVFMgc29uZ3NcIik7XG4gICAgICAgICAgICBkYi5leGVjU1FMKFwiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgc29uZ3MgKGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCwgdGl0bGUgVEVYVCwgYXJ0aXN0IFRFWFQsIGltYWdlIFRFWFQsIGFsYnVtIFRFWFQsIGdlbnJlIFRFWFQsIHRyYWNrIFRFWFQsIHllYXIgVEVYVCwgcGF0aCBURVhUKVwiKS50aGVuKGlkID0+IHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNSRUFURSBUQUJMRSBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJPUEVOIERCIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2hlY2tTb25ncyhzb25nRm9sZGVyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrU29uZ3Moc29uZ0ZvbGRlcjogRm9sZGVyKSB7XG4gICAgICAgIHZhciBhcnJheTogYW55W10gPSBbXTtcbiAgICAgICAgc29uZ0ZvbGRlci5nZXRFbnRpdGllcygpXG4gICAgICAgICAgICAudGhlbigoZW50aXRpZXMpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBlbnRpdGllcyBpcyBhcnJheSB3aXRoIHRoZSBkb2N1bWVudCdzIGZpbGVzIGFuZCBmb2xkZXJzLlxuICAgICAgICAgICAgICAgIGVudGl0aWVzLmZvckVhY2goKGVudGl0eSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZmlsZVN5c3RlbU1vZHVsZS5Gb2xkZXIuZXhpc3RzKGVudGl0eS5wYXRoKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBhcnJheS5jb25jYXQodGhpcy5jaGVja1NvbmdzKGZpbGVTeXN0ZW1Nb2R1bGUuRm9sZGVyLmZyb21QYXRoKGVudGl0eS5wYXRoKSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKCFlbnRpdHkucGF0aC5lbmRzV2l0aChcImRiXCIpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFnczogYW55O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBleHRlbnNpb24gPWVudGl0eS5wYXRoLnNsaWNlKChlbnRpdHkucGF0aC5sYXN0SW5kZXhPZihcIi5cIikgLSAxID4+PiAwKSArIDIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiLS0tLS0tLS0tLS0tLS0tLS1cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXRoOiBcIisgZW50aXR5LnBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRVNURU5TSU9ORTogXCIrZXh0ZW5zaW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXAyXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtcDNcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm0yYVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBR0dJVU5HTyBDT01FIG1wZWdcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydFNvbmcoZW50aXR5LCBcIm1wZWdcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImFwZVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFHR0lVTkdPIENPTUUgYXBlXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRTb25nKGVudGl0eSwgXCJhcGV2MlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiYWFjXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtcDRcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm00YVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibTRiXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtNHBhXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtNHZcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm00clwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiM2dwXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFHR0lVTkdPIENPTUUgbXA0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRTb25nKGVudGl0eSwgXCJtcDRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIndtYVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid212XCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJhc2ZcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQUdHSVVOR08gQ09NRSBhc2ZcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydFNvbmcoZW50aXR5LCBcImFzZlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiZmxhY1wiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBR0dJVU5HTyBDT01FIGZsYWNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydFNvbmcoZW50aXR5LCBcImZsYWNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm9nZ1wiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwib2d2XCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJvZ2FcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm9nbVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwib2d4XCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJvcHVzXCI6IC8vIHJlY29tbWVuZGVkIGZpbGVuYW1lIGV4dGVuc2lvbiBmb3IgT2dnIE9wdXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInNweFwiOiAvLyByZWNvbW1lbmRlZCBmaWxlbmFtZSBleHRlbnNpb24gZm9yIE9nZyBTcGVleFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBR0dJVU5HTyBDT01FIG9nZ1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0U29uZyhlbnRpdHksIFwib2dnXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJhaWZcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImFpZmZcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImFpZmNcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQUdHSVVOR08gQ09NRSBhaWZmXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRTb25nKGVudGl0eSwgXCJhaWZmXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ3YXZcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQUdHSVVOR08gQ09NRSByaWZmXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRTb25nKGVudGl0eSwgXCJyaWZmXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ3dlwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid3ZwXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFHR0lVTkdPIENPTUUgd2F2cGFja1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0U29uZyhlbnRpdHksIFwid2F2cGFja1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXBjXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFHR0lVTkdPIENPTUUgbXVzZXBhY2tcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydFNvbmcoZW50aXR5LCBcIm11c2VwYWNrXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmZldGNoKCk7XG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFUlJPUkU6IFwiK2Vyci5zdGFjayk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbnNlcnRTb25nKGVudGl0eSA6ZmlsZVN5c3RlbU1vZHVsZS5GaWxlU3lzdGVtRW50aXR5LCBmb3JtYXQ6IHN0cmluZyApIHtcbiAgICAgICAgdmFyIGZpbGUgPSBmaWxlU3lzdGVtTW9kdWxlLkZpbGUuZnJvbVBhdGgoZW50aXR5LnBhdGgpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIklOSVpJTyBCVWZmXCIpO1xuICAgICAgICBsZXQgYnVmZiA9IEJ1ZmZlci5mcm9tKGZpbGUucmVhZFN5bmMoKSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGJ1ZmYpO1xuICAgICAgICAvLyByZWFkRmlsZShmaWxlLnBhdGgsIFwidXRmOFwiLCBmdW5jdGlvbihlcnIsIGRhdGEpIHsgIFxuICAgICAgICAvLyAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAvLyAgICAgYnVmZiA9ZGF0YTtcbiAgICAgICAgLy8gfSk7XG4gICAgICAgIFxuICAgICAgICAvLyB0aGlzLm1tciA9IG5ldyBNZWRpYU1ldGFkYXRhUmV0cmlldmVyKClcbiAgICAgICAgLy8gdGhpcy5nZXRNZXRhZGF0YShlbnRpdHkpO1xuICAgICAgICBcbiAgICAgICAgcGFyc2VCdWZmZXIoYnVmZiwgXCJhdWRpby9cIitmb3JtYXQseyBkdXJhdGlvbjogdHJ1ZSwgZmlsZVNpemU6IGZpbGUuc2l6ZX0pLnRoZW4oIG1ldGFkYXRhID0+IHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKG1ldGFkYXRhLmNvbW1vbi50aXRsZSk7XG4gICAgICAgICAgICB0aGlzLmluc2VydERCKCBcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGEuY29tbW9uLnRpdGxlPyBtZXRhZGF0YS5jb21tb24udGl0bGUgOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YS5jb21tb24uYXJ0aXN0PyBtZXRhZGF0YS5jb21tb24uYXJ0aXN0IDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGEuY29tbW9uLnBpY3R1cmU/IFwiZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCxcIiArIG1ldGFkYXRhLmNvbW1vbi5waWN0dXJlWzBdLmRhdGEudG9TdHJpbmcoJ2Jhc2U2NCcpIDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGEuY29tbW9uLmFsYnVtPyBtZXRhZGF0YS5jb21tb24uYWxidW0gOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YS5jb21tb24uZ2VucmU/IG1ldGFkYXRhLmNvbW1vbi5nZW5yZVswXSA6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhLmNvbW1vbi50cmFjay5ubz8gbWV0YWRhdGEuY29tbW9uLnRyYWNrLm5vLnRvU3RyaW5nKCkgOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YS5jb21tb24ueWVhcj8gbWV0YWRhdGEuY29tbW9uLnllYXIudG9TdHJpbmcoKSA6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eS5wYXRoXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgY29uc29sZS5sb2coXCJJTlNFUklNRU5UTyBDT01QTEVUQVRPIVwiKVxufVxuXG5wcml2YXRlIGluc2VydERCKHRpdGxlOiBzdHJpbmcsIGFydGlzdDogc3RyaW5nLCBpbWFnZTogc3RyaW5nLCBhbGJ1bTogc3RyaW5nLCBnZW5yZTogc3RyaW5nLCB0cmFjazogc3RyaW5nLCB5ZWFyOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgIFxuICAgIChuZXcgU3FsaXRlKFwic29uZ3MuZGJcIikpLnRoZW4oZGIgPT4ge1xuXG4gICAgICAgIGRiLmV4ZWNTUUwoXCJJTlNFUlQgSU5UTyBzb25ncyAodGl0bGUsIGFydGlzdCwgaW1hZ2UsIGFsYnVtLCBnZW5yZSwgdHJhY2ssIHllYXIsIHBhdGgpIFZBTFVFUyAoPywgPywgPywgPywgPywgPywgPywgPylcIiwgW3RpdGxlLCBhcnRpc3QsIGltYWdlLCBhbGJ1bSwgZ2VucmUsIHRyYWNrLCB5ZWFyLCBwYXRoXSkudGhlbihpZCA9PiB7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU5TRVJUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJPUEVOIERCIEVSUk9SXCIsIGVycm9yKTtcbiAgICB9KTtcblxufVxuXG5cbiAgICBwdWJsaWMgZmV0Y2goKSB7XG5cbiAgICAgICAgKG5ldyBTcWxpdGUoXCJzb25ncy5kYlwiKSkudGhlbihkYiA9PiB7XG5cbiAgICAgICAgICAgIGRiLmFsbChcIlNFTEVDVCAqIEZST00gc29uZ3NcIikudGhlbihyb3dzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvbmdzID0gW107XG4gICAgICAgICAgICAgICAgZm9yKHZhciByb3cgaW4gcm93cykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc29uZyA9IG5ldyBTb25nO1xuICAgICAgICAgICAgICAgICAgICBzb25nLlRpdGxlID0gcm93c1tyb3ddWzFdO1xuICAgICAgICAgICAgICAgICAgICBzb25nLkFydGlzdCA9IHJvd3Nbcm93XVsyXTtcbiAgICAgICAgICAgICAgICAgICAgc29uZy5JbWFnZSA9IHJvd3Nbcm93XVszXTtcbiAgICAgICAgICAgICAgICAgICAgc29uZy5BbGJ1bSA9IHJvd3Nbcm93XVs0XTtcbiAgICAgICAgICAgICAgICAgICAgc29uZy5HZW5yZSA9IHJvd3Nbcm93XVs1XTtcbiAgICAgICAgICAgICAgICAgICAgc29uZy5UcmFjayA9IHJvd3Nbcm93XVs2XTtcbiAgICAgICAgICAgICAgICAgICAgc29uZy5ZZWFyID0gcm93c1tyb3ddWzddO1xuICAgICAgICAgICAgICAgICAgICBzb25nLlBhdGggPSByb3dzW3Jvd11bOF07XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNvbmdzLnB1c2goc29uZyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU0VMRUNUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiT1BFTiBEQiBFUlJPUlwiLCBlcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIFxuICAgIH1cbiAgICBcblxuICAgIFxuICAgIFxuICAgIC8vIGdldE1ldGFkYXRhKGVudGl0eSA6ZmlsZVN5c3RlbU1vZHVsZS5GaWxlU3lzdGVtRW50aXR5KSB7XG4gICAgLy8gICAgIC8vU2V0IHRoZSBkYXRhIHNvdXJjZSBmb3IgdGhlIG1lZGlhIGZpbGVcbiAgICAvLyAgICAgY29uc29sZS5sb2coZW50aXR5LnBhdGgpO1xuICAgIC8vICAgICB0aGlzLm1tci5zZXREYXRhU291cmNlKGVudGl0eS5wYXRoKTtcblxuICAgIC8vICAgICAvL0dldCB0aGUgRW1iZWRkZWQgUGljdHVyZShCaXRtYXApXG4gICAgLy8gICAgIC8vIHRoaXMubW1yLmdldEVtYmVkZGVkUGljdHVyZSgpXG4gICAgLy8gICAgIC8vIC50aGVuKChhcmdzKSA9PiB7XG4gICAgLy8gICAgIC8vICAgICBpZihhcmdzKSB7XG4gICAgLy8gICAgIC8vICAgICAgICAgdGhpcy5pbWcuc2V0TmF0aXZlU291cmNlKGFyZ3MpO1xuICAgIC8vICAgICAvLyAgICAgY29uc29sZS5sb2coXCJJTU1BR0lORTogXCIrIHRoaXMuaW1nLnRvQmFzZTY0U3RyaW5nKFwianBnXCIpKTtcbiAgICAvLyAgICAgLy8gICAgIH1cbiAgICAvLyAgICAgLy8gfSlcbiAgICAvLyAgICAgLy8gLmNhdGNoKChleCkgPT4ge1xuICAgIC8vICAgICAvLyAgICAgLy9EbyBzb21ldGhpbmcgZWxzZVxuICAgIC8vICAgICAvLyAgICAgY29uc29sZS5sb2coXCJGYWlsZWQgdG8gc2V0IEltYWdlU291cmNlLi4uXCIgKyBleCk7XG4gICAgLy8gICAgIC8vIH0pO1xuXG4gICAgLy8gICAgIC8vR2V0IGFsbCB0aGUgbWV0YWRhdGFcbiAgICAvLyAgICAgdGhpcy5tbXIuZXh0cmFjdEFsbE1ldGFkYXRhKClcbiAgICAvLyAgICAgLnRoZW4oKGFyZ3MpID0+IHtcbiAgICAvLyAgICAgICAgIC8vIGlmKGFyZ3MuX21lZGlhTWV0YWRhdGFSZXRyaWV2ZXIuZ2V0RW1iZWRkZWRQaWN0dXJlKCkpe1xuICAgIC8vICAgICAgICAgLy8gICAgIHRoaXMuaW1nLnNldE5hdGl2ZVNvdXJjZShhcmdzLmltYWdlKTtcbiAgICAvLyAgICAgICAgIC8vIH1cbiAgICAvLyAgICAgICAgIHRoaXMuaW1nLnNldE5hdGl2ZVNvdXJjZShhcmdzLmltYWdlKTtcbiAgICAvLyAgICAgICAgIHRoaXMuaW5zZXJ0REIoIFxuICAgIC8vICAgICAgICAgYXJncy50aXRsZT8gYXJncy50aXRsZSA6IFwiXCIsXG4gICAgLy8gICAgICAgICBhcmdzLmFydGlzdD8gYXJncy5hcnRpc3QgOiBcIlwiLFxuICAgIC8vICAgICAgICAgdGhpcy5pbWc/IFwiZGF0YTppbWFnZS9qcGc7YmFzZTY0LFwiICt0aGlzLmltZy50b0Jhc2U2NFN0cmluZyhcInBuZ1wiKSA6IFwiXCIsLy9cImRhdGE6aW1hZ2UvanBlZztiYXNlNjQsXCIgKyBhcmdzLnBpY3R1cmVbMF0uZGF0YS50b1N0cmluZygnYmFzZTY0JykgOiBcIlwiLFxuICAgIC8vICAgICAgICAgYXJncy5hbGJ1bT8gYXJncy5hbGJ1bSA6IFwiXCIsXG4gICAgLy8gICAgICAgICBhcmdzLmdlbnJlPyBhcmdzLmdlbnJlIDogXCJcIixcbiAgICAvLyAgICAgICAgIGFyZ3MuY2R0cmFja251bWJlcj8gYXJncy5jZHRyYWNrbnVtYmVyIDogXCJcIixcbiAgICAvLyAgICAgICAgIGFyZ3MueWVhcj8gYXJncy55ZWFyLnRvU3RyaW5nKCkgOiBcIlwiLFxuICAgIC8vICAgICAgICAgZW50aXR5LnBhdGhcbiAgICAvLyAgICAgICAgICk7XG4gICAgLy8gICAgIH0pO1xuXG4gICAgICAgIFxuICAgIC8vIH1cbn1cbiJdfQ==